<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>vue-resource</title>
        <link rel="stylesheet" href="style.css">
        <script src="https://cdn.jsdelivr.net/npm/vue"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.4"></script>
    </head>
    <body>
    
      <div id="app">    
         <div class="editor">
                <form @submit.prevent="savePost()">
                    <input type="text" placeholder="Заголовок" v-model="post.title">
                    <textarea placeholder="Текст" v-model="post.body"></textarea>
                    <button>Опубликовать</button>
                </form>
        </div>
        <div id="post" class="post" v-for="(post, index) in posts">
                <h3>{{ post.title }}</h3>
                <input v-if="post.showEditor" v-model="post.title">
                <p>{{ post.body }}</p>
                <textarea v-if="post.showEditor" v-model="post.body"></textarea>
                <button @click="showEditor(index)">Редактировать</button>
                <button @click="deletePost(index)">Удалить</button>
                <button @click="closeEditor(index)" v-if="post.showEditor">Сохранить</button>
                <comments :comments="post.comments">  
                </comments>
                <!--<template class="comments" id="comments" :comments="post.comments">
                  <div class="comment-editor">
                    <form @submit.prevent="saveComment()">
                        <input type="text" placeholder="Имя" v-model="comment.name">
                        <textarea placeholder="Комментарий" v-model="comment.body"></textarea>
                        <button>Добавить комментарий</button>
                    </form>
                  </div>
                  <h3>Комментарии</h3>
                  <div class="comment" v-for="comment in comments">
                    <h4>{{ comment.name }}</h4>
                    <p>{{ comment.body }}</p>
                  </div>
                </template>-->
        </div>   
      </div>  
        
        
        <script>
      
          Vue.use(VueResource)
          
          Vue.component('post', {
            template: '#post',
            props: ['post'],
          })
          
          Vue.component('comments', {
            template: '<div class="comments">\
                  <div class="comment-editor">\
                      <form @submit.prevent="saveComment()">\
                          <input type="text" placeholder="Имя" v-model="comment.name">\
                          <textarea placeholder="Комментарий" v-model="comment.body"></textarea>\
                          <button>Добавить комментарий</button>\
                      </form>\
                  </div>\
                  <h3>Комментарии</h3>\
                  <div class="comment" v-for="comment in comments">\
                    <h4>{{ comment.name }}</h4>\
                    <p>{{ comment.body }}</p>\
                  </div>\
            </div>',
            props: ['comments'],
            data: function() {
              return {
                comments: this.comments,
                comment: {}
              }
            },
            computed: {
              commentResource: function() {
                      return this.$resource('https://jsonplaceholder.typicode.com/comments{/id}')
                  }
            },
            methods: {
              saveComment: function() {
                  this.commentResource.save(this.comment)
                  this.comments.unshift(this.comment)
              }
            }
          })
          
          new Vue({
              el: '#app',
              data: {
                  endpoint: 'https://jsonplaceholder.typicode.com/',
                  posts: [],
                  comments: [],
                  post: {},
                  comment: {}
              },
              computed: {
                  postResource: function() {
                      return this.$resource('https://jsonplaceholder.typicode.com/posts{/id}')
                  }
              },
              methods: {
                  showEditor: function(index) {
                    this.$set(this.posts[index], 'showEditor', true)
                  },
                  
                  closeEditor: function(index) {
                    this.$set(this.posts[index], 'showEditor', false)
                  },
                  
                  deletePost: function(index) {
                    this.posts.splice(index, 1)
                  },
                  
                  savePost: function() {
                      
                      this.postResource.save(this.post)
                      this.posts.unshift(this.post)
          
                  },
                  
                  
                  getAllPosts: function() {
          
                      var options = {
                          params: {
                              _start: 0,
                              _limit: 5
                          },
                          headers: {
                              'Content-Type': 'application/json'
                          }
                      }
          
                      this.$http.get(this.endpoint + 'posts/', options).then(function(response) {
          
                          this.posts = response.data
                          for (let i = 0; i < this.posts.length; i++) {
                            this.getPostComments(this.posts[i]);
                          }
                          console.log(this.posts)
          
                      }, function(error) {
                          // ошибка
                      })
          
                  },
                  getPostComments: function(post) {
                    this.$http.get(this.endpoint + 'posts/' + post.id + '/comments').then(function(response) {
                    this.$set(post, 'comments', response.data)
                    //post.comments = response.data
                    }, function(error) {
                      //ошибка
                    })
                  },
                  /*getAllComments: function() {
                    var options = {
                          params: {
                              _start: 0,
                              _limit: 50
                          },
                          headers: {
                              'Content-Type': 'application/json'
                          }
                      }
          
                      this.$http.get(this.endpoint + 'comments/', options).then(function(response) {
          
                      this.comments = response.data
                      console.log(this.comments)
                      }, function(error) {
                        //ошибка
                      })
                  }*/
              },
              created: function() {
                  this.getAllPosts()
                  //this.getAllComments()
              }
          })
        </script>
    </body>
</html>